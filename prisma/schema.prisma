generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Branch {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  alamatBranch String
  namaBranch   String
  areas        Area[]
  users        User[]
}

model Area {
  id        Int        @id @default(autoincrement())
  branchId  Int
  namaArea  String
  kodeArea  String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  branch    Branch     @relation(fields: [branchId], references: [id])
  odps      ODP[]
  customers Customer[]
  users     User[]
}

model Vendor {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@map("vendors")
}

model ODP {
  id        Int        @id @default(autoincrement())
  areaId    Int
  namaOdp   String
  portOdp   Int
  latOdp    Float
  longOdp   Float
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  area      Area       @relation(fields: [areaId], references: [id])
  customers Customer[]
}

model Router {
  id            Int       @id @default(autoincrement())
  namaRouter    String
  hostAddress   String
  username      String
  password      String
  apiPort       Int       @default(8728)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  uuid          String    @unique @default(uuid())
  isolir        Boolean   @default(false)
  isolirProfile String?   @map("isolir_profile")
  isolirScheme  String    @default("DISABLE") @map("isolir_scheme")
  packages      Package[]
}

model Package {
  id              Int          @id @default(autoincrement())
  routerId        Int
  namaPaket       String
  hargaPaket      Decimal      @db.Decimal(10, 2)
  mikrotikProfile String
  displayPaket    Boolean      @default(true)
  deskripsi       String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  connections     Connection[]
  router          Router       @relation(fields: [routerId], references: [id])

  @@map("packages")
}

model Customer {
  id                       Int                       @id @default(autoincrement())
  namaPelanggan            String
  alamatPelanggan          String
  teleponPelanggan         String
  identitasPelanggan       String
  latitude                 Float?
  longitude                Float?
  areaId                   Int
  odpId                    Int?
  odpPortId                Int?
  statusPelanggan          String                    @default("ACTIVE")
  tanggalAktif             DateTime?
  tanggalAkhir             DateTime?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  idPelanggan              String                    @unique
  diskon                   Decimal                   @default(0) @db.Decimal(10, 2)
  autoIsolate              Boolean                   @default(true)
  tanggalToleransi         DateTime?
  taxId                    Int?
  useTax                   Boolean                   @default(false)
  connections              Connection[]
  activeAddons             CustomerAddon[]
  activeDiscounts          CustomerDiscount[]
  area                     Area                      @relation(fields: [areaId], references: [id])
  odp                      ODP?                      @relation(fields: [odpId], references: [id])
  tax                      Tax?                      @relation(fields: [taxId], references: [id])
  invoices                 Invoice[]
  transactions             Transaction[]
  promises                 PromiseToPay[]
  connectionChangeRequests ConnectionChangeRequest[]

  @@map("customers")
}

model Tax {
  id        Int        @id @default(autoincrement())
  name      String
  value     Int
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  customers Customer[]

  @@map("taxes")
}

model Connection {
  id                       Int                       @id @default(autoincrement())
  pelangganId              Int
  paketId                  Int
  secretMode               String                    @default("NEW") @map("secret_mode") // NEW, EXISTING, NONE
  pppUsername              String?                   @unique
  pppPassword              String?
  pppService               String?                   @default("pppoe")
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  paket                    Package                   @relation(fields: [paketId], references: [id])
  pelanggan                Customer                  @relation(fields: [pelangganId], references: [id])
  connectionChangeRequests ConnectionChangeRequest[]

  @@map("connections")
}

model Addon {
  id             Int             @id @default(autoincrement())
  name           String
  price          Decimal         @db.Decimal(10, 2)
  description    String?
  customerAddons CustomerAddon[]

  @@map("addons")
}

model Discount {
  id                Int                @id @default(autoincrement())
  name              String
  type              String
  value             Decimal            @db.Decimal(10, 2)
  startDate         DateTime?          @map("start_date")
  endDate           DateTime?          @map("end_date")
  customerDiscounts CustomerDiscount[]

  @@map("discounts")
}

model CustomerAddon {
  id         Int      @id @default(autoincrement())
  customerId Int
  addonId    Int
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  addon      Addon    @relation(fields: [addonId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@map("customer_addons")
}

model CustomerDiscount {
  id         Int      @id @default(autoincrement())
  customerId Int
  discountId Int
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  customer   Customer @relation(fields: [customerId], references: [id])
  discount   Discount @relation(fields: [discountId], references: [id])

  @@map("customer_discounts")
}

model User {
  id            String         @id @default(uuid())
  name          String?
  email         String         @unique
  emailVerified Boolean        @default(false)
  image         String?
  username      String         @unique
  password      String?
  role          String         @default("ADMIN")
  roleId        Int?
  userRole      Role?          @relation(fields: [roleId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  transactions  Transaction[]
  promises      PromiseToPay[]
  sessions      Session[]
  accounts      Account[]
  branchId      Int?
  branch        Branch?        @relation(fields: [branchId], references: [id])
  areas         Area[]
  theme         String         @default("blue")
  position      String?
  vendorId      Int?
  vendor        Vendor?        @relation(fields: [vendorId], references: [id])

  @@map("users")
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  users       User[]
  permissions RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("roles")
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("permissions")
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verifications")
}

model Jwks {
  id         String   @id
  publicKey  String
  privateKey String
  createdAt  DateTime @default(now())

  @@map("jwks")
}

model Invoice {
  id                Int            @id @default(autoincrement())
  invoiceNumber     String         @unique
  customerId        Int
  category          String         @default("RECURRING")
  type              String         @default("PREPAID")
  period            DateTime
  amount            Decimal        @db.Decimal(10, 2)
  status            String         @default("UNPAID")
  transactionId     Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  hariToleransi     Int            @default(0)
  tanggalJatuhTempo DateTime
  items             InvoiceItem[]
  customer          Customer       @relation(fields: [customerId], references: [id])
  transaction       Transaction?   @relation(fields: [transactionId], references: [id])
  promises          PromiseToPay[]

  @@map("invoices")
}

model InvoiceItem {
  id          Int     @id @default(autoincrement())
  invoiceId   Int
  description String
  itemType    String
  amount      Decimal @db.Decimal(10, 2)
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model Transaction {
  id            Int       @id @default(autoincrement())
  referenceNo   String    @unique
  amountPaid    Decimal   @db.Decimal(10, 2)
  paymentMethod String    @default("CASH")
  proofImage    String?   @db.Text
  adminId       String
  customerId    Int?
  createdAt     DateTime  @default(now())
  invoices      Invoice[]
  admin         User      @relation(fields: [adminId], references: [id])
  customer      Customer? @relation(fields: [customerId], references: [id])

  @@map("transactions")
}

model PromiseToPay {
  id          Int      @id @default(autoincrement())
  customerId  Int
  invoiceId   Int?
  promiseDate DateTime
  note        String?
  status      String   @default("WAITING")
  adminId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
  invoice  Invoice? @relation(fields: [invoiceId], references: [id])
  admin    User     @relation(fields: [adminId], references: [id])

  @@map("promises_to_pay")
}

model NetworkMap {
  id        String   @id @default(uuid())
  name      String
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("network_maps")
}

model UpgradeRequest {
  id             Int      @id @default(autoincrement())
  connectionId   Int
  customerId     Int
  currentPaketId Int
  newPaketId     Int
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  requestNote    String?
  approvalNote   String?
  requestedBy    String? // username who requested
  approvedBy     String? // username who approved/rejected
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("upgrade_requests")
}

model CustomerChangeRequest {
  id         Int @id @default(autoincrement())
  customerId Int

  // Current values (snapshot at request time)
  currentNama      String
  currentAlamat    String
  currentTelepon   String
  currentIdentitas String
  currentAreaId    Int
  currentOdpId     Int?
  currentOdpPortId Int?
  currentLatitude  Float?
  currentLongitude Float?

  // New values (requested changes)
  newNama      String
  newAlamat    String
  newTelepon   String
  newIdentitas String
  newAreaId    Int
  newOdpId     Int?
  newOdpPortId Int?
  newLatitude  Float?
  newLongitude Float?

  // Workflow fields
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  requestNote  String?
  approvalNote String?
  requestedBy  String?
  approvedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("customer_change_requests")
}

model CustomerStatusRequest {
  id         Int @id @default(autoincrement())
  customerId Int

  // Status change info
  currentStatus String // ACTIVE, NONAKTIF, BERHENTI
  newStatus     String // NONAKTIF (berhenti sementara), BERHENTI (berhenti berlangganan)
  reason        String? // Alasan perubahan status

  // Workflow fields
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  requestNote  String?
  approvalNote String?
  requestedBy  String?
  approvedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("customer_status_requests")
}

model ConnectionChangeRequest {
  id           Int @id @default(autoincrement())
  connectionId Int
  customerId   Int

  // Current values
  currentPppUsername String?
  currentPppPassword String?
  currentPppService  String?
  currentSecretMode  String?
  currentPaketId     Int?

  // New values
  newPppUsername String?
  newPppPassword String?
  newPppService  String?
  newSecretMode  String?
  newPaketId     Int?

  // Workflow fields
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  requestNote  String?
  approvalNote String?
  requestedBy  String?
  approvedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customer   Customer   @relation(fields: [customerId], references: [id])
  connection Connection @relation(fields: [connectionId], references: [id])

  @@map("connection_change_requests")
}
